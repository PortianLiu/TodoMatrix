name: Build & Release TodoMatrix

# 触发条件：打以v开头的Tag时触发（如v2.1.6）
on:
  push:
    tags:
      - 'v*'  # 匹配v1.0.0、v2.1.6等Tag

# 作业：在Windows环境运行（因Inno Setup仅Windows可用）
jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      # 步骤1：检出仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：安装Flutter环境（指定稳定版）
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.7'
          channel: 'stable'

      # 步骤3：安装Flutter依赖
      - name: Install dependencies
        run: flutter pub get

      # 步骤4：构建Windows Release产物
      - name: Build Windows Release
        run: flutter build windows --release

      # 步骤5：构建Android Release APK
      - name: Build Android Release APK
        run: flutter build apk --release --split-per-abi  # 可选：拆分ABI，也可去掉--split-per-abi

      # 步骤6：安装7-Zip（压缩Windows Release用）和Inno Setup（打包用）
      - name: Install 7-Zip and Inno Setup
        run: |
          choco install 7zip -y  
          choco install innosetup -y  

      # 步骤7：压缩Windows Release目录（规范化命名）
      - name: Compress Windows Release
        run: |
          $VERSION = "${{ github.ref_name }}".Replace("v", "")
          7z a -t7z -mx=9 -mmt=on "build/TodoMatrix_Win_Release_v$VERSION.7z" "build/windows/x64/runner/Release/*"

      # 步骤8：用Inno Setup打包Windows安装包（传入版本号）
      - name: Build Windows Installer with Inno Setup
        run: |
          $VERSION = "${{ github.ref_name }}".Replace("v", "")
          $env:MY_APP_VERSION = $VERSION
          iscc "installer/Inno Setup/TodoMatrix.iss" /O"build" /F"TodoMatrix_Setup_x64_v$VERSION"

      # 步骤9：规范化重命名APK（默认APK名→TodoMatrix_Android_v2.1.6.apk）
      - name: Rename APK
        run: |
          $VERSION = "${{ github.ref_name }}".Replace("v", "")
          Copy-Item "build/app/outputs/flutter-apk/app-release.apk" "build/TodoMatrix_Android_v$VERSION.apk"

      # 步骤10：自动发布到GitHub Release页（上传所有产物）
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # 要上传的文件列表（压缩包、安装包、APK）
          files: |
            build/TodoMatrix_Win_Release_v${{ github.ref_name }}.7z
            build/installer/TodoMatrix_Setup_x64_v${{ github.ref_name }}.exe
            build/TodoMatrix_Android_v${{ github.ref_name }}.apk
          # 可选：自动生成Release说明（也可手动改）
          body: |
            ## TodoMatrix v${{ github.ref_name }}
            - Windows安装包：TodoMatrix_Setup_x64_v${{ github.ref_name }}.exe
            - Portable：TodoMatrix_Win_Release_v${{ github.ref_name }}.zip
            - Android APK：TodoMatrix_Android_v${{ github.ref_name }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动生成的令牌，无需手动配置
